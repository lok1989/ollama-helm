#!/bin/ksh

# Validate PROFILE is passed
if [[ -z "$PROFILE" ]]; then
  echo "ERROR: PROFILE environment variable not set. Must be 'UAT' or 'PROD'."
  exit 1
fi

# Directory to scan
OUTGOING_DIR="/data/outgoing"

# Path to SSH private key (update as needed)
KEY_PATH="$HOME/.ssh/id_rsa"

# Initialize environment-specific destination map
typeset -A DEST_MAP

if [[ "$PROFILE" == "UAT" ]]; then
  DEST_MAP["INV_"]="uat_user1@sftp.uat-acme.com"
  DEST_MAP["PAY_"]="uat_user2@sftp.uat-beta.com"
  DEST_MAP["LOG_"]="uat_user3@sftp.uat-gamma.com"

elif [[ "$PROFILE" == "PROD" ]]; then
  DEST_MAP["INV_"]="prod_user1@sftp.prod-acme.com"
  DEST_MAP["PAY_"]="prod_user2@sftp.prod-beta.com"
  DEST_MAP["LOG_"]="prod_user3@sftp.prod-gamma.com"

else
  echo "ERROR: Invalid PROFILE '$PROFILE'. Expected 'UAT' or 'PROD'."
  exit 2
fi

# Process each file in the outgoing folder
for FILE in "$OUTGOING_DIR"/*; do
  BASENAME=$(basename "$FILE")
  SENT=0

  for PATTERN in "${!DEST_MAP[@]}"; do
    if [[ "$BASENAME" == ${PATTERN}* ]]; then
      DEST="${DEST_MAP[$PATTERN]}"
      echo "[$PROFILE] Transferring $BASENAME to $DEST..."

      sftp -i "$KEY_PATH" "$DEST" <<EOF
put "$FILE"
EOF

      if [[ $? -eq 0 ]]; then
        echo "[$PROFILE] Successfully transferred $BASENAME to $DEST"
        SENT=1
        break
      else
        echo "[$PROFILE] ERROR transferring $BASENAME to $DEST"
      fi
    fi
  done

  if [[ $SENT -eq 0 ]]; then
    echo "[$PROFILE] No matching pattern for $BASENAME. Skipping."
  fi
done





String filter = "";
String whereClause = "";

// Check and extract filters
if (request.getFilters() != null && request.getFilters().length > 0) {
    List<RunQueryRequest.Filter> filters = List.of(request.getFilters());
    filter = filters.get(0).getFilters();

    // Case-insensitive check and parse for firmCd
    if (filter != null && filter.toLowerCase().contains("[firmcd] equals")) {
        String[] parts = filter.split("(?i)equals");  // (?i) = case-insensitive
        if (parts.length == 2) {
            String fieldName = parts[0].replace("[", "").replace("]", "").trim();  // e.g., firmCd
            String value = parts[1].trim();  // e.g., 01
            if (!fieldName.isEmpty() && !value.isEmpty()) {
                whereClause = " WHERE " + fieldName.toUpperCase() + " = '" + value + "'";
            }
        }
    }
}

// Build the final SQL query
String sql = "SELECT * FROM ARCHIVE.RICH_SETT_LADDER_POSITION_CACHE" +
             whereClause +
             " LIMIT " + request.getPageSize() +
             " OFFSET " + (request.getPage() * request.getPageSize());

SqlFieldsQuery query = new SqlFieldsQuery(sql);
